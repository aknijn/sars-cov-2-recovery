<?xml version='1.0' encoding='utf-8'?>
<tool name="bcftools covid @EXECUTABLE@" id="bcftools_covid_@EXECUTABLE@" version="@TOOL_VERSION@">
    <description>Create covid consensus sequence by applying VCF variants to a reference fasta file</description>
    <macros>
        <token name="@EXECUTABLE@">consensus</token>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements">
        <expand macro="samtools_requirement"/>
        <requirement type="package" version="5.0.1">gawk</requirement>
    </expand>
    <expand macro="version_command" />
    <command detect_errors="aggressive"><![CDATA[
#import subprocess
awk 'BEGIN { OFS="\t" }!/#/{cinit=index($8,"DP="); cend=index($8,";DPR="); $8=substr($8,cinit+3,cend-cinit-3); print $1,$2,$8; }' $input_file > even.txt;
awk '{ while (NR + shift < $2) { print $1 "\t" (NR + shift); shift++ }; }' even.txt > consensus.tab;
awk -v cutoff="$cutoff" 'BEGIN { OFS="\t" }!/#/{ if ($3 < cutoff) print $1,$2; }' even.txt >> consensus.tab;
@PREPARE_ENV@
@PREPARE_INPUT_FILE@
#set $section = $reference_source
@PREPARE_FASTA_REF@

bcftools @EXECUTABLE@

@FASTA_REF@

## Default section
#set $section = $sec_default

${section.iupac_codes}

--mask consensus.tab

#if $section.select_haplotype:
  --haplotype '${section.select_haplotype}'
#end if
@SAMPLE@

#if $chain:
  --chain '$chain_file'
#end if

## Primary Input/Outputs
@INPUT_FILE@
#set basename =  $subprocess.check_output('cat ' + str($strainname), shell=True)
| awk 'BEGIN {i=1} {if (match($0, /^>/)) {if (i==1) {name="${basename}"} else {name=sprintf("%s-%d","${basename}",i);} print(gensub(/>[^ ]+( ?.*)/, ">" name "\\1", 1)); i=i+1;} else {print}}' > '$output_file'
]]>
    </command>
    <inputs>
        <expand macro="macro_input" />
        <expand macro="macro_fasta_ref" />
        <section name="sec_default" expanded="true" title="Default Options">
            <param name="iupac_codes" type="boolean" truevalue="--iupac-codes" falsevalue="" label="Iupac Codes" 
                   help="Output variants in the form of IUPAC ambiguity codes" />
            <expand macro="macro_sample" />
            <param name="select_haplotype" type="select" optional="true">
                <option value="1">1</option>
                <option value="2">2</option>
            </param>
        </section>
        <param name="chain" type="boolean" truevalue="yes" falsevalue="no" label="Write a chain file for liftover" />
        <param name="strainname" format="txt" type="data" label="Set output FASTA ID with Strain name" />
        <param name="cutoff" type="integer" value="100" label="cutoff for base assignment" help="" />
    </inputs>
    <outputs>
        <data name="output_file" format="fasta" label="${tool.name} on ${on_string}: consensus fasta"/>
        <data name="chain_file" format="txt" label="${tool.name} on ${on_string}: chain">
            <filter>chain</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <expand macro="test_using_reference" ref="consensus.fa" />
            <param name="input_file" ftype="vcf" value="consensus.vcf" />
            <param name="mask" ftype="tabular" value="consensus.tab" />
            <param name="chain" value="True" />
            <output name="output_file">
                <assert_contents>
                    <has_text text="NNNNNNNNNNNNNNNNNNNNNNNNNN" />
                </assert_contents>
            </output>
            <output name="chain_file">
                <assert_contents>
                    <has_text text="chain 497 1 501 + 1 501 1 502 + 1 502 1" />
                </assert_contents>
            </output>
        </test>
        <test>
            <expand macro="test_using_reference" select_from="cached" ref="consensus" />
            <param name="input_file" ftype="vcf" dbkey="?" value="consensus.vcf" />
            <param name="mask" ftype="tabular" value="consensus.tab" />
            <param name="chain" value="True" />
            <output name="output_file">
                <assert_contents>
                    <has_text text="NNNNNNNNNNNNNNNNNNNNNNNNNN" />
                </assert_contents>
            </output>
            <output name="chain_file">
                <assert_contents>
                    <has_text text="chain 497 1 501 + 1 501 1 502 + 1 502 1" />
                </assert_contents>
            </output>
        </test>
        <test>
            <expand macro="test_using_reference" ref="consensus.fa" />
            <param name="input_file" ftype="vcf" value="consensus.vcf" />
            <param name="mask" ftype="tabular" value="consensus.tab" />
            <param name="chain" value="False" />
            <param name="rename" value="True" />
            <output name="output_file">
                <assert_contents>
                    <has_text text=">consensus.vcf" />
                </assert_contents>
                <assert_contents>
                    <has_text text=">consensus.vcf-2" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
=====================================
 bcftools @EXECUTABLE@ plugin
=====================================


Create consensus sequence by applying VCF variants to a reference fasta file.

@BCFTOOLS_MANPAGE@#@EXECUTABLE@

@BCFTOOLS_WIKI@

The option to set the new consensus' FASTA ID from the name of the VCF is provided by post-processing
the bcftools consensus output. It is primarily intended for use when the VCF is coming from a list
collection where the elements of the list are named meaningfully (e.g. named after sample names). This
is useful when consensus sequences are being prepared for, for example, feeding a multiple sequence
alignment to a phylogeny program.
]]>
    </help>
    <expand macro="citations" />
</tool>
