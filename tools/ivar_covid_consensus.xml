<tool id="ivar_covid_consensus" name="ivar covid consensus" version="3.1+galaxy0">
    <description>Call consensus from aligned BAM file</description>
    <requirements>
      <requirement type="package" version="1.2">ivar</requirement>
      <requirement type="package" version="1.9">samtools</requirement>
      <yield />
    </requirements>
    <version_command>ivar version | grep version</version_command>
    <command detect_errors="exit_code"><![CDATA[
        #import re
        #import subprocess
        #set $idname = $subprocess.getoutput('cat ' + str($strainname))
        #set $library = $subprocess.getoutput('cat ' + str($librarytype))
        #set $clean_name = re.sub('[^\w\-]', '_', str($idname))
        ln -s '$input_bam' sorted.bam &&
        samtools mpileup -A -d 0 -Q 0 sorted.bam | ivar consensus 
        -p consensus
        -t 0.6
        -n N
        #if str( $library ) == "sang":
          -q 1
          -m 1
		#else:
          -q 20
          -m 30
        #end if
        &&
        sed -i "1s|.*|>$clean_name|" consensus.fa
    ]]>    </command>
    <inputs>
        <param name="input_bam" type="data" format="bam" label="Bam file" help="Aligned reads, to trim primers and quality"/>
        <param name="strainname" type="data" format="txt"  label="Set output FASTA ID with Strain name" />
        <param name="librarytype" type="data" format="txt" label="library type" />
    </inputs>
    <outputs>
        <data name="consensus" format="fasta" label="${tool.name} on ${on_string} Consensus" from_work_dir="consensus.fa"/>
    </outputs>
    <citations>
      <citation type="doi">10.1186/s13059-018-1618-7</citation>
    </citations>
</tool>
